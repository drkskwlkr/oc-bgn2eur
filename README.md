# OpenCart BGN to EUR Price Converter

## Въведение

На 1 януари 2026 г. България приема еврото като официална валута. Този инструмент автоматизира преизчисляването на всички цени в OpenCart магазин от български лев (BGN) в евро (EUR) съгласно законово определения обменен курс от 1 EUR = 1.95583 BGN.

**Важно:** Преди да използвате този инструмент, трябва да добавите валутата EUR в настройките на вашия OpenCart магазин. Скриптът НЕ създава валута EUR автоматично - той само проверява дали съществува и преизчислява цените.

## Режими на изпълнение

Скриптът може да се изпълнява по два начина:

- **Команден ред (CLI):** Препоръчителният метод. Избягва проблеми с timeout при изпълнение през уеб сървър, особено при магазини с голям брой продукти.
- **Уеб интерфейс:** Възможен, но не се препоръчва за големи магазини поради риск от прекъсване при ограничения на времето за изпълнение.

## Изисквания

- PHP 7.4 или по-нова версия
- Инсталация на OpenCart
- Достъп до база данни
- Валутата EUR трябва да е добавена в настройките на магазина
- Препоръчителен е достъп чрез команден ред (за избягване на проблеми с timeout)

## Инсталация

1. Изтеглете скриптовете от GitHub:
   ```bash
   git clone https://github.com/drkskwlkr/oc-bgn2eur.git
   ```

2. Копирайте примерния конфигурационен файл:
   ```bash
   cp config.example.php config.local.php
   ```

3. Редактирайте `config.local.php` и въведете:
   - `EUR_EXCHANGE_RATE` - Обменен курс (по закон: 1.95583)
   - `OC_ROOT_PATH` - Път към root директорията на OpenCart магазина

   **Пример за CLI изпълнение:**
   ```php
   const EUR_EXCHANGE_RATE = 1.95583;
   const OC_ROOT_PATH = '/home/username/public_html';
   ```

   **Пример за уеб изпълнение (скриптът е в root на магазина):**
   ```php
   const EUR_EXCHANGE_RATE = 1.95583;
   const OC_ROOT_PATH = __DIR__;
   ```

## Налични команди

### Проверки и информация

#### `discover`
Проверява дали скриптът е позициониран правилно и извлича данни за базата данни.

```bash
php oc-bgn2eur.php discover
```

#### `currency`
Проверява конфигурацията на валутите (BGN е основна валута, EUR съществува).

```bash
php oc-bgn2eur.php currency
```

#### `stat`
Показва статистика за продуктите и очаквано използване на RAM.

```bash
php oc-bgn2eur.php stat
```

#### `list`
Извежда списък на всички продукти с цени и ценови модификатори.

```bash
php oc-bgn2eur.php list
```

### Управление на резервни копия

#### `backup`
Създава резервни копия на таблиците с цени преди конверсия.

```bash
php oc-bgn2eur.php backup
```

**ВАЖНО:** Винаги създавайте резервно копие преди конверсия!

#### `restore`
Възстановява таблиците от резервни копия при проблем.

```bash
php oc-bgn2eur.php restore
```

#### `cleanup`
Изтрива резервните копия. Препоръчително е да го направите само след като сте се уверили, че конверсията е протекла успешно.

```bash
php oc-bgn2eur.php cleanup
```

### Режим на поддръжка

#### `maintenance enable|disable`
Активира или деактивира режим на поддръжка на магазина.

```bash
php oc-bgn2eur.php maintenance enable
php oc-bgn2eur.php maintenance disable
```

**Препоръка:** Активирайте режим на поддръжка преди конверсия, за да не позволявате на потребителите да взаимодействат със сайта в този критичен момент.

### Конверсия на цени

#### `recalculate`
Извършва проверки и показва какво ще бъде направено (dry run).

```bash
php oc-bgn2eur.php recalculate
```

#### `recalculate simulate`
Изчислява новите цени и ги показва на екрана БЕЗ да ги записва в базата.

```bash
php oc-bgn2eur.php recalculate simulate
```

#### `recalculate proceed`
Извършва действителната конверсия и записва новите цени в базата данни.

```bash
php oc-bgn2eur.php recalculate proceed
```

## Препоръчителен работен процес

1. **Проверка на средата:**
   ```bash
   php oc-bgn2eur.php discover
   php oc-bgn2eur.php currency
   php oc-bgn2eur.php stat
   ```

2. **Активиране на режим на поддръжка:**
   ```bash
   php oc-bgn2eur.php maintenance enable
   ```

3. **Създаване на резервно копие:**
   ```bash
   php oc-bgn2eur.php backup
   ```

4. **Проверка преди конверсия:**
   ```bash
   php oc-bgn2eur.php recalculate
   ```

5. **Симулация (по избор):**
   ```bash
   php oc-bgn2eur.php recalculate simulate
   ```

6. **Извършване на конверсия:**
   ```bash
   php oc-bgn2eur.php recalculate proceed
   ```

7. **Проверка на резултатите:**
   - Разгледайте магазина
   - Проверете цените на няколко продукта
   - Тествайте процеса на поръчка

8. **При успех:**
   ```bash
   php oc-bgn2eur.php cleanup
   php oc-bgn2eur.php maintenance disable
   ```

9. **При проблем:**
   ```bash
   php oc-bgn2eur.php restore
   php oc-bgn2eur.php maintenance disable
   ```

## Изпълнение през уеб интерфейс

Ако нямате достъп до команден ред, можете да изпълнявате командите през браузър.

**Къде да поставите скриптовете:**
- **В root директорията на магазина** (напр. `/public_html/`): Достъпни на `https://your-site.com/oc-bgn2eur.php`
- **В поддиректория** (напр. `/public_html/tools/`): Достъпни на `https://your-site.com/tools/oc-bgn2eur.php`
- **Извън публичната директория** (препоръчително за сигурност): Изисква CLI достъп

**Примери за използване:**

```
https://your-site.com/oc-bgn2eur.php?cmd=discover
https://your-site.com/oc-bgn2eur.php?cmd=stat
https://your-site.com/oc-bgn2eur.php?cmd=backup
https://your-site.com/oc-bgn2eur.php?cmd=recalculate&param=simulate
https://your-site.com/oc-bgn2eur.php?cmd=recalculate&param=proceed
https://your-site.com/oc-bgn2eur.php?cmd=maintenance&param=enable
```

**Внимание:** 
- Уеб изпълнението може да прекъсне при големи магазини поради ограничения на сървъра.
- След завършване на конверсията изтрийте скриптовете от публичната директория за сигурност.

## Важни забележки

- **Винаги правете резервно копие преди конверсия!**
- Скриптът преизчислява цени в следните таблици:
  - `product` - основни цени на продукти
  - `product_option_value` - цени на опции
  - `product_discount` - отстъпки при количество
  - `product_special` - промоционални цени
- Всички цени се делят на 1.95583 и закръгляват до 2 десетични знака
- След конверсия трябва ръчно да:
  1. Активирате EUR като основна валута
  2. Зададете обменен курс EUR = 1.00000000
  3. В зависимост от използвания механизъм за показване на двойни цени може да се наложи да зададете ръчно обменен курс EUR/BGN (0.51129) за BGN като вторична валута.
  4. Деактивирайте BGN като валута, без да я изтривате.

## Лиценз

MIT License
